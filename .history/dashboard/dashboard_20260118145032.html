<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Admin - Festa dello Sport</title>
    <link rel="stylesheet" href="https://cdn.tailwindcss.com">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="bg-gray-100">
    <!-- Sidebar -->
    <div class="flex h-screen">
        <div class="w-64 bg-blue-800 text-white">
            <div class="p-4">
                <h2 class="text-xl font-bold">Dashboard Admin</h2>
                <p id="admin-info" class="text-sm text-blue-200 mt-2"></p>
            </div>
            <nav class="mt-8">
                <a href="#dashboard" class="nav-link block px-4 py-2 hover:bg-blue-700" data-section="dashboard">
                    <i class="fas fa-tachometer-alt mr-2"></i>Dashboard
                </a>
                <a href="#eventi" class="nav-link block px-4 py-2 hover:bg-blue-700" data-section="eventi">
                    <i class="fas fa-calendar-alt mr-2"></i>Eventi
                </a>
                <a href="#menu" class="nav-link block px-4 py-2 hover:bg-blue-700" data-section="menu">
                    <i class="fas fa-utensils mr-2"></i>Menu
                </a>
                <a href="#statistiche" class="nav-link block px-4 py-2 hover:bg-blue-700" data-section="statistiche">
                    <i class="fas fa-chart-bar mr-2"></i>Statistiche
                </a>
                <button id="logout-btn" class="w-full text-left block px-4 py-2 hover:bg-red-700 text-red-200">
                    <i class="fas fa-sign-out-alt mr-2"></i>Logout
                </button>
            </nav>
        </div>

        <!-- Main Content -->
        <div class="flex-1 p-8">
            <div id="content">
                <!-- Dashboard Section -->
                <div id="dashboard-section" class="section">
                    <h1 class="text-3xl font-bold mb-8">Dashboard</h1>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="bg-white p-6 rounded-lg shadow">
                            <h3 class="text-lg font-semibold mb-2">Prenotazioni</h3>
                            <p id="prenotazioni-count" class="text-2xl font-bold text-blue-600">0</p>
                        </div>
                        <div class="bg-white p-6 rounded-lg shadow">
                            <h3 class="text-lg font-semibold mb-2">Feedback</h3>
                            <p id="feedback-count" class="text-2xl font-bold text-green-600">0</p>
                        </div>
                        <div class="bg-white p-6 rounded-lg shadow">
                            <h3 class="text-lg font-semibold mb-2">Eventi</h3>
                            <p id="eventi-count" class="text-2xl font-bold text-purple-600">0</p>
                        </div>
                    </div>
                </div>

                <!-- Eventi Section -->
                <div id="eventi-section" class="section hidden">
                    <div class="flex justify-between items-center mb-8">
                        <h1 class="text-3xl font-bold">Gestione Eventi</h1>
                        <button id="add-evento-btn" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
                            <i class="fas fa-plus mr-2"></i>Aggiungi Evento
                        </button>
                    </div>
                    <div class="bg-white rounded-lg shadow overflow-hidden">
                        <table class="w-full">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Nome</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Data</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Luogo</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Azioni</th>
                                </tr>
                            </thead>
                            <tbody id="eventi-table-body">
                                <!-- Eventi verranno caricati qui -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Menu Section -->
                <div id="menu-section" class="section hidden">
                    <div class="flex justify-between items-center mb-8">
                        <h1 class="text-3xl font-bold">Gestione Menu</h1>
                        <button id="add-menu-btn" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
                            <i class="fas fa-plus mr-2"></i>Aggiungi Piatto
                        </button>
                    </div>
                    <div class="bg-white rounded-lg shadow overflow-hidden">
                        <table class="w-full">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Nome</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Categoria</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Prezzo</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Azioni</th>
                                </tr>
                            </thead>
                            <tbody id="menu-table-body">
                                <!-- Menu verrà caricato qui -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Statistiche Section -->
                <div id="statistiche-section" class="section hidden">
                    <h1 class="text-3xl font-bold mb-8">Statistiche</h1>
                    <div class="bg-white p-6 rounded-lg shadow">
                        <p class="text-gray-600">Statistiche dettagliate verranno implementate qui.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <!-- Evento Modal -->
    <div id="evento-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center">
        <div class="bg-white p-8 rounded-lg w-full max-w-md">
            <h2 id="evento-modal-title" class="text-2xl font-bold mb-4">Aggiungi Evento</h2>
            <form id="evento-form">
                <input type="hidden" id="evento-id">
                <div class="mb-4">
                    <label class="block text-sm font-medium mb-2">Nome</label>
                    <input type="text" id="evento-nome" class="w-full p-2 border rounded" required>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium mb-2">Data</label>
                    <input type="date" id="evento-data" class="w-full p-2 border rounded" required>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium mb-2">Luogo</label>
                    <input type="text" id="evento-luogo" class="w-full p-2 border rounded" required>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium mb-2">Descrizione</label>
                    <textarea id="evento-descrizione" class="w-full p-2 border rounded" rows="3"></textarea>
                </div>
                <div class="flex justify-end space-x-2">
                    <button type="button" id="cancel-evento-btn" class="px-4 py-2 bg-gray-500 text-white rounded">Annulla</button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded">Salva</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Menu Modal -->
    <div id="menu-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center">
        <div class="bg-white p-8 rounded-lg w-full max-w-md">
            <h2 id="menu-modal-title" class="text-2xl font-bold mb-4">Aggiungi Piatto</h2>
            <form id="menu-form">
                <input type="hidden" id="menu-id">
                <div class="mb-4">
                    <label class="block text-sm font-medium mb-2">Nome</label>
                    <input type="text" id="menu-nome" class="w-full p-2 border rounded" required>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium mb-2">Categoria</label>
                    <input type="text" id="menu-categoria" class="w-full p-2 border rounded" placeholder="es. Primi, Secondi, Bevande">
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium mb-2">Prezzo (€)</label>
                    <input type="number" step="0.01" id="menu-prezzo" class="w-full p-2 border rounded">
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium mb-2">Descrizione</label>
                    <textarea id="menu-descrizione" class="w-full p-2 border rounded" rows="3"></textarea>
                </div>
                <div class="mb-4">
                    <label class="flex items-center">
                        <input type="checkbox" id="menu-disponibile" class="mr-2" checked>
                        Disponibile
                    </label>
                </div>
                <div class="flex justify-end space-x-2">
                    <button type="button" id="cancel-menu-btn" class="px-4 py-2 bg-gray-500 text-white rounded">Annulla</button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded">Salva</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        let currentSection = 'dashboard';

        // Verifica login
        function checkLogin() {
            fetch('/api/admin/check', { credentials: 'include' })
                .then(response => response.json())
                .then(data => {
                    if (!data.logged_in) {
                        window.location.href = '/dashboard/login.html';
                    } else {
                        document.getElementById('admin-info').textContent = `Benvenuto, ${data.nome}`;
                        loadDashboard();
                    }
                })
                .catch(() => {
                    window.location.href = '/dashboard/login.html';
                });
        }

        // Carica dashboard
        function loadDashboard() {
            fetch('/api/stats', { credentials: 'include' })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        document.getElementById('prenotazioni-count').textContent = data.data.prenotazioni.totale;
                        document.getElementById('feedback-count').textContent = data.data.feedback.totale;
                    }
                });

            fetch('/api/admin/eventi', { credentials: 'include' })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        document.getElementById('eventi-count').textContent = data.data.length;
                    }
                });
        }

        // Navigazione
        document.querySelectorAll('.nav-link').forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const section = e.target.closest('a').dataset.section;
                showSection(section);
            });
        });

        function showSection(section) {
            document.querySelectorAll('.section').forEach(s => s.classList.add('hidden'));
            document.getElementById(`${section}-section`).classList.remove('hidden');
            currentSection = section;

            if (section === 'eventi') loadEventi();
            if (section === 'menu') loadMenu();
        }

        // Eventi
        function loadEventi() {
            fetch('/api/admin/eventi', { credentials: 'include' })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const tbody = document.getElementById('eventi-table-body');
                        tbody.innerHTML = data.data.map(evento => `
                            <tr>
                                <td class="px-6 py-4">${evento.nome}</td>
                                <td class="px-6 py-4">${new Date(evento.data).toLocaleDateString('it-IT')}</td>
                                <td class="px-6 py-4">${evento.luogo}</td>
                                <td class="px-6 py-4 space-x-2">
                                    <button onclick="editEvento(${evento.id})" class="text-blue-600 hover:text-blue-800">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button onclick="deleteEvento(${evento.id})" class="text-red-600 hover:text-red-800">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </td>
                            </tr>
                        `).join('');
                    }
                });
        }

        function editEvento(id) {
            fetch(`/api/admin/eventi/${id}`, { credentials: 'include' })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const evento = data.data;
                        document.getElementById('evento-id').value = evento.id;
                        document.getElementById('evento-nome').value = evento.nome;
                        document.getElementById('evento-data').value = evento.data;
                        document.getElementById('evento-luogo').value = evento.luogo;
                        document.getElementById('evento-descrizione').value = evento.descrizione || '';
                        document.getElementById('evento-modal-title').textContent = 'Modifica Evento';
                        document.getElementById('evento-modal').classList.remove('hidden');
                    }
                });
        }

        function deleteEvento(id) {
            if (confirm('Sei sicuro di voler eliminare questo evento?')) {
                fetch(`/api/admin/eventi/${id}`, {
                    method: 'DELETE',
                    credentials: 'include'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        loadEventi();
                    }
                });
            }
        }

        // Menu
        function loadMenu() {
            fetch('/api/admin/menu', { credentials: 'include' })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const tbody = document.getElementById('menu-table-body');
                        tbody.innerHTML = data.data.map(item => `
                            <tr>
                                <td class="px-6 py-4">${item.nome}</td>
                                <td class="px-6 py-4">${item.categoria}</td>
                                <td class="px-6 py-4">${item.prezzo ? '€' + item.prezzo : '-'}</td>
                                <td class="px-6 py-4 space-x-2">
                                    <button onclick="editMenu(${item.id})" class="text-blue-600 hover:text-blue-800">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button onclick="deleteMenu(${item.id})" class="text-red-600 hover:text-red-800">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </td>
                            </tr>
                        `).join('');
                    }
                });
        }

        function editMenu(id) {
            fetch(`/api/admin/menu/${id}`, { credentials: 'include' })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const item = data.data;
                        document.getElementById('menu-id').value = item.id;
                        document.getElementById('menu-nome').value = item.nome;
                        document.getElementById('menu-categoria').value = item.categoria;
                        document.getElementById('menu-prezzo').value = item.prezzo;
                        document.getElementById('menu-descrizione').value = item.descrizione || '';
                        document.getElementById('menu-disponibile').checked = item.disponibile;
                        document.getElementById('menu-modal-title').textContent = 'Modifica Piatto';
                        document.getElementById('menu-modal').classList.remove('hidden');
                    }
                });
        }

        function deleteMenu(id) {
            if (confirm('Sei sicuro di voler eliminare questo piatto?')) {
                fetch(`/api/admin/menu/${id}`, {
                    method: 'DELETE',
                    credentials: 'include'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        loadMenu();
                    }
                });
            }
        }

        // Event Listeners
        document.getElementById('add-evento-btn').addEventListener('click', () => {
            document.getElementById('evento-form').reset();
            document.getElementById('evento-id').value = '';
            document.getElementById('evento-modal-title').textContent = 'Aggiungi Evento';
            document.getElementById('evento-modal').classList.remove('hidden');
        });

        document.getElementById('cancel-evento-btn').addEventListener('click', () => {
            document.getElementById('evento-modal').classList.add('hidden');
        });

        document.getElementById('evento-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData);
            const id = data.id;
            delete data.id;

            const method = id ? 'PUT' : 'POST';
            const url = id ? `/api/admin/eventi/${id}` : '/api/admin/eventi';

            fetch(url, {
                method: method,
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    document.getElementById('evento-modal').classList.add('hidden');
                    loadEventi();
                }
            });
        });

        document.getElementById('add-menu-btn').addEventListener('click', () => {
            document.getElementById('menu-form').reset();
            document.getElementById('menu-id').value = '';
            document.getElementById('menu-disponibile').checked = true;
            document.getElementById('menu-modal-title').textContent = 'Aggiungi Piatto';
            document.getElementById('menu-modal').classList.remove('hidden');
        });

        document.getElementById('cancel-menu-btn').addEventListener('click', () => {
            document.getElementById('menu-modal').classList.add('hidden');
        });

        document.getElementById('menu-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData);
            const id = data.id;
            delete data.id;
            data.prezzo = data.prezzo ? parseFloat(data.prezzo) : null;
            data.disponibile = data.disponibile === 'on';

            const method = id ? 'PUT' : 'POST';
            const url = id ? `/api/admin/menu/${id}` : '/api/admin/menu';

            fetch(url, {
                method: method,
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    document.getElementById('menu-modal').classList.add('hidden');
                    loadMenu();
                }
            });
        });

        document.getElementById('logout-btn').addEventListener('click', () => {
            fetch('/api/admin/logout', {
                method: 'POST',
                credentials: 'include'
            })
            .then(() => {
                window.location.href = '/dashboard/login.html';
            });
        });

        // Inizializzazione
        checkLogin();
    </script>
</body>
</html>